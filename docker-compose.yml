services:
    influxdb:
        image: influxdb:2
        container_name: influxdb
        ports:
            - "8086:8086"                     # UI en http://localhost:8086
        environment:
            DOCKER_INFLUXDB_INIT_MODE: setup
            DOCKER_INFLUXDB_INIT_USERNAME: admin
            DOCKER_INFLUXDB_INIT_PASSWORD: admin123
            DOCKER_INFLUXDB_INIT_ORG: agil
            DOCKER_INFLUXDB_INIT_BUCKET: k6          # bucket donde k6 escribirÃ¡
            DOCKER_INFLUXDB_INIT_RETENTION: 0        # sin caducidad
        volumes:
            - influxdb2-data:/var/lib/influxdb2
            - influxdb2-config:/etc/influxdb2

    k6:
        image: grafana/k6:latest
        container_name: k6
        depends_on:
            - influxdb
        volumes:
            - ./k6/functionary/tests:/scripts
        entrypoint: >
            sh -c "k6 run --out influxdb=http://k6user:k6pass@influxdb:8086/k6 /scripts/front-functionary.js"

    grafana:
        image: grafana/grafana:10.4.2
        container_name: grafana
        ports:
            - "3300:3000"
        depends_on:
            - influxdb
        volumes:
            - grafana-data:/var/lib/grafana

volumes:
    influxdb2-data:
    influxdb2-config:
    grafana-data:
